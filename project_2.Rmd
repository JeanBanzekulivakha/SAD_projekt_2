---
title: "[SAD] Projekt 2"
author: "Banzekulivakha Zhan, Ostoja-Lniski Robert"
date: "09-06-2021"
output: html_document
---


## Struktura projektu
Struktura katalogów w projekcie przedstawia się nastepująco:

* data - katalog przechowyjący dane
* info - katalog przechowujący pliki z treścią zadania
* renv - katalog odpowiedzialny ze wirtulane środowisko języka R
* projekt_2.Rmd - główny plik (notatnik) zawierajcy kod źródłowy
* projekt_2.html - plik wynikowy projekt1.Rmd
* inne pliki konfiguracjne

## Wymagane biblioteki i konfiguracja pakeitu *knit*
Poniżej linkwoane bibliteki są wymagane do poprawnej "kompilacji" notatnika, stąd też wymagana jest ich wcześniejsza instalacja. W projekcie użyliśmy biblioteki readxl do wczytywania plików o rozszerzeniu xlsx oraz xls, ggplot2 do pomocniczej wizualizacji, także dplyr do operacji na dataframe.

```{r setup, warning=FALSE, message=FALSE}

library("readxl")
library(ggplot2)
library(dplyr)


knitr::opts_chunk$set(echo = TRUE)
```

## Zadanie 1a

Sprawdz, czy proces szczepien przeciw SARS-CoV-2 przebiega równie szybko we wszystkich województwach, tzn. czy liczba szczepien jest proporcjonalna do populacji tych wojewdództw.


### Przygotowanie danych
Sekcja ta definiuje funkcje odpowiedzilne za odpowiednie wczytanie danych i ich przygotowanie.

* read_vaccination_data - wczytuje dane odnośnie szczepień z arkusza kalkulacyjnego
* read_population_data - wczytuje informacje o populacji danego województwa. Pobraliśmy w tym celu dodatkowy, ogólno dostępny zbiór danych statystycznych ze strony https://stat.gov.pl
* area_to_population - otrzymując województwo na wejściu zwraca jego populację
* count_vaccined_to_population - Dla każdego województwa oblicza stosunek sumarycznej liczby osób zaszczepionych (całkowicie) danego dnia do populacji

```{r}

read_vaccination_data <- function(data_dir, data_file) {
  data_file_path <- paste0(data_dir, data_file)
  df <- read_excel(data_file_path, sheet="dane", range = "AG4:BL165")
  df_dates <- read_excel(data_file_path, sheet="dane", range = "A4:A165")
  colnames(df_dates) <- c("date")
  df$date <- as.Date(df_dates$date, format = '%Y-%m-%d')
  colnames(df) <- c("dolnoslaskie_ogolem","dolnoslaskie_calkowicie",
                    "kujawskopomorskie_ogolem", "kujawskopomorskie_calkowicie",
                    "lubelskie_ogolem", "lubelskie_calkowicie",
                    "lubuskie_ogolem", "lubuskie_calkowicie",
                    "lodzkie_ogolem", "lodzkie_calkowicie",
                    "malopolskie_ogolem", "malopolskie_calkowicie",
                    "mazowieckie_ogolem", "mazowieckie_calkowicie",
                    "opolskie_ogolem", "opolskie_calkowicie",
                    "podkarpackie_ogolem", "podkarpackie_calkowicie",
                    "podlaskie_ogolem", "podlaskie_calkowicie",
                    "pomorskie_ogolem", "pomorskie_calkowicie",
                    "slaskie_ogolem", "slaskie_calkowicie",
                    "swietokrzyskie_ogolem", "swietokrzyskie_calkowicie",
                    "warminskomazurskie_ogolem", "warminskomazurskie_calkowicie",
                    "wielkopolskie_ogolem", "wielkopolskie_calkowicie",
                    "zachodniopomorskie_ogolem", "zachodniopomorskie_calkowicie",
                    "date")
  df <- df[-c(2:18, 20:21),]
  return(df)
}

read_population_data <- function(data_dir, data_file) {
  data_file_path <- paste0(data_dir, data_file)
  df <- read_excel(data_file_path, sheet="TABL.1", range = "E10:E26")
  colnames(df) <- c("population")
  area_name <- c("dolnoslaskie",
                  "kujawskopomorskie",
                  "lubelskie",
                  "lubuskie",
                  "lodzkie",
                  "malopolskie",
                  "mazowieckie",
                  "opolskie",
                  "podkarpackie",
                  "podlaskie",
                  "pomorskie",
                  "slaskie",
                  "swietokrzyskie",
                  "warminskomazurskie",
                  "wielkopolskie",
                  "zachodniopomorskie")
  df["area"] <- area_name
  return(df)
}

area_to_population <- function(population_data, area_info) {
  area_name <- gsub("\\_.*","",area_info)
  area_population <- population_data$population[ population_data$area==area_name ]
  return(area_population)
}

count_vaccined_to_population <- function(population_data, vaccination_data) {
  data_column_names <- names(vaccination_data)
  data_column_names <- data_column_names[ data_column_names != 'date']
  for(i in data_column_names) {
    area_population <- area_to_population(population_data, i)
    vaccination_data[[i]] <- as.numeric(as.character(vaccination_data[[i]])) / area_population * 100
  }

  return(vaccination_data)
}

```

### Pomocnicza wizualizacja
W celu lepszej analizy, zdecydowaliśmy się przed wykonaniem testów zwizualizować dane, aby poznać spodziewane wyniki. Poniższy kod jest odpowiedzialny za porównanie przebiegu szczepień i zaprezentowanie go na wykresie

```{r, message=FALSE}
vaccination_data <- read_vaccination_data(data_dir = "data/", data_file = "covid_szczepienia.xlsx")
population_data <- read_population_data(data_dir = "data/", data_file = "ludnosc.xls")
vaccination_data <- count_vaccined_to_population(population_data, vaccination_data)

vaccination_data_total <- vaccination_data %>% select(ends_with("calkowicie"), "date")

ggplot(vaccination_data_total, aes(date)) +
  geom_line(aes(y = mazowieckie_calkowicie,color = "mazowieckie")) +
  geom_line(aes(y = lodzkie_calkowicie,color = "lodzkie")) +
  geom_line(aes(y = slaskie_calkowicie,color = "slaskie")) +
  geom_line(aes(y = lubelskie_calkowicie,color = "lubelskie")) +
  geom_line(aes(y = kujawskopomorskie_calkowicie,color = "kujawsko-pomorskie")) +
  geom_line(aes(y = warminskomazurskie_calkowicie,color = "warminsko-mazurskie")) +
  geom_line(aes(y = swietokrzyskie_calkowicie,color = "swietokrzyskie")) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 20)) +
  scale_x_date(breaks = "1 week") +
  theme(axis.text.x = element_text(angle = 90, hjust=1)) +
  labs(
    title = "Przebieg szczepien w poszczegolnych wojewodztwach",
    x = "data",
    y = "Procent osób zaszczepionych [%]"
  )
```

Wykres wskazuje bardzo zbliżony postęp szczepień we wszystkich badanych województwach. Między niektórymi województwami, przykładowo mazowieckim i świętokrzyskim, występuje różnica rzędu kilku procent. Z drugiej strony porównując przebieg szczepień w województwie łódzkim i śląskim różnice nieznaczne. Spodziewamy się, że wynik testu hipotezy, że proces szczepień przebiega równie szybko we wszystkich województwach będzie inny badając parę województwo mazowieckie - województwo świętorzyskie niż w przypadku województwo łódzkie - województwo śląskie.

### Testowanie hipotezy

Przeprowadziliśmy badania hipotezy porównując rozkłady (...)

``` {r}
count <- nrow(vaccination_data_total)
test_mazowieckie <- rnorm(n=count, mean = mean(vaccination_data_total$mazowieckie_calkowicie), sd = sd(vaccination_data_total$mazowieckie_calkowicie))
test_lodzkie <- rnorm(n=count, mean = mean(vaccination_data_total$lodzkie_calkowicie), sd = sd(vaccination_data_total$lodzkie_calkowicie))
current_test <- t.test(test_mazowieckie, test_lodzkie, var.equal = TRUE)
print(current_test)

test_slaskie <- rnorm(n=count, mean = mean(vaccination_data_total$slaskie_calkowicie), sd = sd(vaccination_data_total$slaskie_calkowicie))
current_test <- t.test(test_slaskie, test_lodzkie, var.equal = TRUE)
print(current_test)

test_lubelskie <- rnorm(n=count, mean = mean(vaccination_data_total$lubelskie_calkowicie), sd = sd(vaccination_data_total$lubelskie_calkowicie))
current_test <- t.test(test_slaskie, test_lubelskie, var.equal = TRUE)
print(current_test)

test_kujawskopomorskie <- rnorm(n=count, mean = mean(vaccination_data_total$kujawskopomorskie_calkowicie), sd = sd(vaccination_data_total$kujawskopomorskie_calkowicie))
current_test <- t.test(test_kujawskopomorskie, test_lubelskie, var.equal = TRUE)
print(current_test)

test_warminskomazurskie <- rnorm(n=count, mean = mean(vaccination_data_total$warminskomazurskie_calkowicie), sd = sd(vaccination_data_total$warminskomazurskie_calkowicie))
current_test <- t.test(test_kujawskopomorskie, test_warminskomazurskie, var.equal = TRUE)
print(current_test)

test_swietokrzyskie <- rnorm(n=count, mean = mean(vaccination_data_total$swietokrzyskie_calkowicie), sd = sd(vaccination_data_total$swietokrzyskie_calkowicie))
current_test <- t.test(test_warminskomazurskie, test_swietokrzyskie, var.equal = TRUE)
print(current_test)

```

## Zadanie 1b

Sprawdz, czy skutecznosc leczenia osób zarazonych wirusem SARS-CoV-2 jest taka sama na terenie całej Polski, tzn. czy liczba przypadków smiertelnych jest proporcjonalna do liczby osób zarazonych w poszczególnych województwach.

### Przygotowanie danych
Sekcja ta definiuje funkcje odpowiedzilne za odpowiednie wczytanie danych i ich przygotowanie.

* read_curation_data - wczytuje sumaryczne dane odnośnie zgonów
* add_curation_efficiency_column - dodaje do dataframe kolumnę obliczającą procentową jakość leczenia
* read_daily_cases_sum - wczytuje dzienną sumaryczną liczbę przypadków dla każdego województwa
* read_daily_deaths_sum - wczytuje dzienną sumaryczną liczbę zgonów dla każdego województwa

```{r}

read_curation_data <- function(data_dir, data_file) {
  data_file_path <- paste0(data_dir, data_file)
  df <- read_excel(data_file_path, sheet="Aktualna sytuacja w Polsce", range = "B2:G18")
  colnames(df) <- c("wojewodztwo","suma_potwierdzonych","suma_zgonow","suma_wyzdrowien", "nieaktyne_przypadki", "aktywne_przypadki")
  return(df)
}

add_curation_efficiency_column <- function(df) {
  df <- transform(df, efektywnosc_leczenia = suma_zgonow / suma_potwierdzonych * 100)
  return(df)
}

read_daily_cases_sum <- function(data_dir, data_file) {
  data_file_path <- paste0(data_dir, data_file)
  df <- read_excel(data_file_path, sheet="Wzrost w województwach", range = "B31:QT47")
  df2 <- data.frame(t(df[-1]))
  colnames(df2) <- c("dolnoslaskie",
                  "kujawskopomorskie",
                  "lubelskie",
                  "lubuskie",
                  "lodzkie",
                  "malopolskie",
                  "mazowieckie",
                  "opolskie",
                  "podkarpackie",
                  "podlaskie",
                  "pomorskie",
                  "slaskie",
                  "swietokrzyskie",
                  "warminskomazurskie",
                  "wielkopolskie",
                  "zachodniopomorskie")
  return(df2)
}

read_daily_deaths_sum <- function(data_dir, data_file) {
  data_file_path <- paste0(data_dir, data_file)
  df <- read_excel(data_file_path, sheet="Wzrost w województwach", range = "B71:QT87")
  df2 <- data.frame(t(df[-1]))
  colnames(df2) <- c("dolnoslaskie",
                  "kujawskopomorskie",
                  "lubelskie",
                  "lubuskie",
                  "lodzkie",
                  "malopolskie",
                  "mazowieckie",
                  "opolskie",
                  "podkarpackie",
                  "podlaskie",
                  "pomorskie",
                  "slaskie",
                  "swietokrzyskie",
                  "warminskomazurskie",
                  "wielkopolskie",
                  "zachodniopomorskie")
  return(df2)
}

```

### Pomocnicza wizualizacja
W tym zdaniu również zdecydowaliśmy się na pomocniczą wizualizację. Wykres przedstawia efektywność leczenia pacjentów w najpóźniejszym (najbardziej aktualnym) dniu.

``` {r}

curation_data <- read_curation_data(data_dir = "data/", data_file = "covid_w_polsce.xlsx")
curation_data <- add_curation_efficiency_column(curation_data)
curation_data <- curation_data[order(curation_data$efektywnosc_leczenia),]

draw_efficiency_chart <- function(df) {
  ggplot(data=df, aes(wojewodztwo, efektywnosc_leczenia)) +
    theme_bw() +
    geom_bar(stat='identity') +
    scale_y_continuous(breaks = scales::pretty_breaks(n = 20)) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    scale_x_discrete(limits= df$wojewodztwo) +
    labs(
      title = paste("Skutecznosc leczenia wirusa Sars-cov-2 w podziale na wojewodztwa"),
      x = "",
      y = "Skutecznosc leczenia [%]"
    )
}

draw_efficiency_chart(curation_data)

```

### Testowanie hipotezy

Przeprowadziliśmy badania hipotezy porównując rozkłady (...)

``` {r}

daily_cases_sum <- read_daily_cases_sum(data_dir = "data/", data_file = "covid_w_polsce.xlsx")
daily_deaths_sum <- read_daily_deaths_sum(data_dir = "data/", data_file = "covid_w_polsce.xlsx")
daily_curation_ratio <- daily_deaths_sum / daily_cases_sum
daily_curation_ratio[is.na(daily_curation_ratio)] <- 0

set.seed(0)

count <- nrow(daily_curation_ratio)

test_mazowieckie <- rnorm(n=count, mean = mean(daily_curation_ratio$mazowieckie), sd = sd(daily_curation_ratio$mazowieckie))
test_lodzkie <- rnorm(n=count, mean = mean(daily_curation_ratio$lodzkie), sd = sd(daily_curation_ratio$lodzkie))
current_test <- t.test(test_mazowieckie, test_lodzkie, var.equal = TRUE)
print(current_test)

test_slaskie <- rnorm(n=count, mean = mean(daily_curation_ratio$slaskie), sd = sd(daily_curation_ratio$slaskie))
current_test <- t.test(test_slaskie, test_lodzkie, var.equal = TRUE)
print(current_test)

test_lubelskie <- rnorm(n=count, mean = mean(daily_curation_ratio$lubelskie), sd = sd(daily_curation_ratio$lubelskie))
current_test <- t.test(test_slaskie, test_lubelskie, var.equal = TRUE)
print(current_test)

test_kujawskopomorskie <- rnorm(n=count, mean = mean(daily_curation_ratio$kujawskopomorskie), sd = sd(daily_curation_ratio$kujawskopomorskie))
current_test <- t.test(test_kujawskopomorskie, test_lubelskie, var.equal = TRUE)
print(current_test)

test_warminskomazurskie <- rnorm(n=count, mean = mean(daily_curation_ratio$warminskomazurskie), sd = sd(daily_curation_ratio$warminskomazurskie))
current_test <- t.test(test_kujawskopomorskie, test_warminskomazurskie, var.equal = TRUE)
print(current_test)

test_swietokrzyskie <- rnorm(n=count, mean = mean(daily_curation_ratio$swietokrzyskie), sd = sd(daily_curation_ratio$swietokrzyskie))
current_test <- t.test(test_warminskomazurskie, test_swietokrzyskie, var.equal = TRUE)
print(current_test)


```

## Zadanie 1c

W kazdym z powyzszych przypadków wskaz ewentualnie, które województwa istotnie sie od siebie róznia pod katem rozwazanych statystyk.

### Rozwiązanie
Do rozwiązania c skorzystwaliśmy z wykresów wygenerowanych w powyższych podpunktach. Na ich podstawie przeprowadziliśmy dodatkowe testy między województwami o skrajnych wartościach.

#### Przebieg procesu szczepień



#### Skuteczność leczenia


## Zadanie 2


```{r}

```

